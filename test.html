<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Order Jasa Vakum</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Include Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    #map {
      width: 100%;
      height: 300px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    :root{
      --color-primary:#10b981;
      --color-accent:#ef4444;
      --neutral-900:#111827;
      --neutral-500:#6b7280;
      --neutral-100:#f3f4f6;
      --white:#ffffff;
      --radius:10px;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --shadow-sm:0 2px 10px rgba(0,0,0,.06);
    }

    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--neutral-100);
      color: var(--neutral-900);
      line-height: 1.55;
    }

    .container {
      max-width: 720px;
      margin: 32px auto;
      padding: 24px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    h2 { margin: 0 0 8px; }
    h3 { margin: 20px 0 8px; }

    label {
      display:block;
      margin-top: 14px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      width:100%;
      padding: 10px 12px;
      border:1px solid #E5E7EB;
      border-radius: 8px;
      background: var(--white);
      outline: none;
      transition: box-shadow .2s, border-color .2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--primary-300, #6ee7b7);
      box-shadow: 0 0 0 4px rgba(16,185,129,.15);
    }
    textarea { min-height: 100px; resize: vertical; }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      margin-top: 16px;
      background: var(--color-primary);
      color: var(--white);
      padding: 12px 14px;
      border:0;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      transition: transform .05s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(.98); }
    .btn:active { transform: translateY(1px); }
    .btn-secondary{
      width:auto;
      background:#059669;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    hr {
      border:0;
      height:1px;
      background:#e5e7eb;
      margin: 20px 0;
    }

    /* Estimasi box */
    #estimasi{
      margin-top: 10px;
      background: #f0fdf4;
      border: 1px solid #dcfce7;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      white-space: pre-wrap;
    }
    #estimasi p { margin: 0 0 6px; }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success {
      background: #10b981;
    }
    .toast.error {
      background: #ef4444;
    }

    /* Native select disembunyikan tapi tetap ada untuk validasi/submit */
    .visually-hidden {
      position: absolute !important;
      left: -9999px !important;
      width: 1px; height: 1px;
      overflow: hidden;
    }

    /* Multi Select kustom */
    .ms {
      position: relative;
      margin-top: 8px;
    }
    .ms-control {
      min-height: 44px;
      padding: 6px 8px;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      display:flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      cursor: text;
      background: var(--white);
      transition: box-shadow .2s, border-color .2s;
    }
    .ms-control.is-open {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(16,185,129,.15);
    }
    .ms-placeholder {
      color: var(--neutral-500);
      font-size: 14px;
      padding: 6px 4px;
      user-select: none;
    }
    .ms-chips {
      display:flex;
      flex-wrap: wrap;
      gap:6px;
      align-items:center;
      flex: 1 1 auto;
    }
    .ms-chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #ecfeff;
      border: 1px solid #cffafe;
      color: #0369a1;
      font-size: 13px;
      line-height: 1;
      white-space: nowrap;
    }
    .ms-chip button {
      border:0;
      background: transparent;
      color: var(--neutral-500);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      display:flex;
      align-items:center;
    }
    .ms-input {
      flex: 1 1 160px;
      min-width: 120px;
      border:0;
      outline: none;
      font-size: 14px;
      padding: 6px 4px;
    }

    .ms-dropdown {
      position:absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--white);
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 20;
      display:none;
    }
    .ms-dropdown.open { display:block; }
    .ms-search {
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px;
      border-bottom:1px solid #F3F4F6;
    }
    .ms-search input{
      width:100%;
      border:1px solid #E5E7EB;
      border-radius: 8px;
      padding: 8px 10px;
      outline: none;
      font-size: 14px;
    }
    .ms-actions {
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 8px 10px;
      border-bottom:1px solid #F3F4F6;
      gap:8px;
    }
    .ms-actions .link {
      background: transparent;
      color: var(--color-primary);
      border:0;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .ms-list {
      max-height: 220px;
      overflow:auto;
      padding: 6px 4px;
    }
    .ms-item {
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    .ms-item:hover { background: #f9fafb; }
    .ms-item input { pointer-events: none; }
    .ms-empty {
      padding: 12px;
      color: var(--neutral-500);
      text-align: center;
      font-size: 14px;
      display:none;
    }
    .ms-empty.show { display:block; }

    /* Info lokasi */
    .info-box {
      margin-top: 10px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      padding:10px;
      border-radius:8px;
      font-size: 14px;
    }

    @media (max-width: 640px){
      .container{ margin: 16px; padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Form Pemesanan Jasa Vakum</h2>

    <form id="orderForm" novalidate>
      <label for="nama">Nama:</label>
      <input type="text" id="nama" required>

      <label for="telepon">No. Tlp:</label>
      <input type="text" id="telepon" required>

      <h3>Share Lokasi Anda</h3>
      <button type="button" id="btnLokasi" class="btn btn-secondary">üìç Dapatkan Lokasi Saya</button>
      <div id="map"></div>
      <div id="lokasiInfo" class="info-box" aria-live="polite" hidden></div>

      <label for="alamat">Alamat Lengkap:</label>
      <textarea id="alamat" required placeholder="Tolong isi alamat lengkap anda disini"></textarea>

      <label for="kelurahan">Kelurahan:</label>
      <input type="text" id="kelurahan" required>

      <label for="kecamatan">Kecamatan:</label>
      <input type="text" id="kecamatan" required>

      <label for="kota">Kota:</label>
      <input type="text" id="kota" required>

      <hr>
      <h3>#Waktu Kunjungan#</h3>
      <label for="tanggal">Tanggal (dd/mm/yy):</label>
      <input type="date" id="tanggal" required>

      <label for="pukul">Pukul:</label>
      <input type="time" id="pukul" required>

      <hr>
      <h3>#Rincian Layanan#</h3>

      <label for="paket">Pilih Paket Anda:</label>

      <!-- Hidden select untuk packages dari database -->
      <select id="paket" class="visually-hidden" multiple required>
        <!-- Options akan diisi oleh JavaScript dari database -->
      </select>

      *Bisa pilih lebih dari satu paket
      <div class="ms" id="paket-ms">
        <div class="ms-control" role="combobox" aria-expanded="false" aria-owns="paket-list" aria-haspopup="listbox">
          <div class="ms-chips" id="paket-chips"></div>
          <input class="ms-input" id="paket-search" type="text" placeholder="Cari & pilih paket..." aria-autocomplete="list" aria-controls="paket-list" />
          <span class="ms-placeholder" id="paket-placeholder">Pilih satu atau lebih paket</span>
        </div>
        <div class="ms-dropdown" id="paket-dropdown" role="listbox" aria-multiselectable="true">
          <div class="ms-search">
            <input type="text" id="paket-search-dup" placeholder="Ketik untuk mencari paket..." aria-label="Cari paket">
          </div>
          <div class="ms-actions">
            <button type="button" class="link" id="paket-select-all">Pilih semua</button>
            <button type="button" class="link" id="paket-clear">Hapus semua</button>
          </div>
          <div class="ms-list" id="paket-list"></div>
          <div class="ms-empty" id="paket-empty">Tidak ada hasil</div>
        </div>
      </div>

      <div id="estimasi" aria-live="polite"></div>

      <hr>

      <button type="submit" class="btn" id="submitBtn">
        <span id="submitText">Kirim ke WhatsApp</span>
        <div id="submitSpinner" class="spinner" style="display: none;"></div>
      </button>
    </form>
  </div>

  <script>
    // Konfigurasi Supabase - GANTI DENGAN KONFIGURASI ANDA
 const SUPABASE_URL = 'https://hyrzyjcgrkejicttuzjs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5cnp5amNncmtlamljdHR1empzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjI5MjEsImV4cCI6MjA3NjM5ODkyMX0.f5vNMJNboj6wLT7qJfE8VJlqBBeJR0-sIc7r2NBb3c8';
    
    // Inisialisasi Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global variables
    let map, marker, userLat, userLng;

    // Toast notification function
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize map
    function initMap() {
      const mapElement = document.getElementById('map');
      if (!mapElement) {
        console.error('Map element not found');
        return;
      }

      try {
        map = L.map('map').setView([-6.2, 106.8], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        console.log('Map initialized successfully');
      } catch (error) {
        console.error('Error initializing map:', error);
      }
    }

    // Ambil data packages dari database - HANYA dari tabel package
    async function loadPackages() {
      try {
        console.log('Loading packages from database...');
        
        const { data: packages, error } = await supabase
          .from('package')
          .select('*')
          .order('price', { ascending: true });

        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }

        console.log('Packages loaded:', packages);

        const selectEl = document.getElementById('paket');
        if (!selectEl) {
          console.error('Package select element not found');
          return;
        }

        selectEl.innerHTML = '';
        
        if (packages && packages.length > 0) {
          packages.forEach(pkg => {
            const option = document.createElement('option');
            option.value = `${pkg.id}|${pkg.name}|${pkg.price}`;
            option.textContent = `${pkg.name} - Rp ${pkg.price.toLocaleString('id-ID')}`;
            selectEl.appendChild(option);
          });
          
          console.log('Packages added to select:', packages.length);
          
          // Re-initialize multi-select dengan data baru
          initializeMultiSelect();
        } else {
          console.warn('No packages found in database');
          showToast('Tidak ada paket tersedia', 'error');
        }
      } catch (error) {
        console.error('Error loading packages:', error);
        showToast('Gagal memuat data paket dari database', 'error');
        
        // Fallback: tampilkan paket default jika database error
        loadDefaultPackages();
      }
    }

    // Fallback function jika database tidak bisa diakses
    function loadDefaultPackages() {
      const selectEl = document.getElementById('paket');
      if (!selectEl) return;

      const defaultPackages = [
        { id: 1, name: 'Package Basic', price: 150000 },
        { id: 2, name: 'Package Standard', price: 250000 },
        { id: 3, name: 'Package Ultimate 1', price: 400000 },
        { id: 4, name: 'Package Ultimate 2', price: 600000 }
      ];

      selectEl.innerHTML = '';
      
      defaultPackages.forEach(pkg => {
        const option = document.createElement('option');
        option.value = `${pkg.id}|${pkg.name}|${pkg.price}`;
        option.textContent = `${pkg.name} - Rp ${pkg.price.toLocaleString('id-ID')}`;
        selectEl.appendChild(option);
      });

      console.log('Loaded default packages');
      initializeMultiSelect();
    }

    // MultiSelect Kustom untuk #paket
    let selectEl, msRoot, msControl, chipsWrap, inputInline, dropdown, listWrap, emptyEl, searchDup, btnSelectAll, btnClear, placeholder;
    let options = [];

    function initializeMultiSelect() {
      selectEl = document.getElementById('paket');
      msRoot = document.getElementById('paket-ms');
      
      if (!selectEl || !msRoot) {
        console.error('Multi-select elements not found');
        return;
      }

      msControl = msRoot.querySelector('.ms-control');
      chipsWrap = document.getElementById('paket-chips');
      inputInline = document.getElementById('paket-search');
      dropdown = document.getElementById('paket-dropdown');
      listWrap = document.getElementById('paket-list');
      emptyEl = document.getElementById('paket-empty');
      searchDup = document.getElementById('paket-search-dup');
      btnSelectAll = document.getElementById('paket-select-all');
      btnClear = document.getElementById('paket-clear');
      placeholder = document.getElementById('paket-placeholder');

      // Pastikan semua elemen ada
      if (!msControl || !chipsWrap || !inputInline || !dropdown || !listWrap || !emptyEl || !searchDup || !btnSelectAll || !btnClear || !placeholder) {
        console.error('Some multi-select elements are missing');
        return;
      }

      options = Array.from(selectEl.options).map((o, idx)=>({
        label: o.text,
        value: o.value,
        selected: o.selected,
        idx
      }));

      // Re-initialize semua event listeners
      initMultiSelectEvents();
      renderList(options);
      renderChips();
      
      console.log('Multi-select initialized with', options.length, 'packages');
    }

    function openDropdown(){
      dropdown.classList.add('open');
      msControl.classList.add('is-open');
      msControl.setAttribute('aria-expanded', 'true');
      searchDup.value = inputInline.value;
      searchDup.focus();
      filterList(searchDup.value);
    }
    
    function closeDropdown(){
      dropdown.classList.remove('open');
      msControl.classList.remove('is-open');
      msControl.setAttribute('aria-expanded', 'false');
    }

    // Render list options
    function renderList(filtered = options){
      if (!listWrap) return;
      
      listWrap.innerHTML = '';
      filtered.forEach(opt=>{
        const item = document.createElement('div');
        item.className = 'ms-item';
        item.setAttribute('role','option');
        item.setAttribute('aria-selected', String(!!opt.selected));
        item.dataset.value = opt.value;

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!opt.selected;
        cb.tabIndex = -1;

        const label = document.createElement('span');
        label.textContent = opt.label;

        item.appendChild(cb);
        item.appendChild(label);
        item.addEventListener('click', ()=>{
          toggleValue(opt.value);
        });

        listWrap.appendChild(item);
      });
      emptyEl.classList.toggle('show', filtered.length === 0);
    }

    // Render chips
    function renderChips(){
      if (!chipsWrap) return;
      
      chipsWrap.innerHTML = '';
      const selected = options.filter(o=>o.selected);
      selected.forEach(opt=>{
        const chip = document.createElement('span');
        chip.className = 'ms-chip';
        chip.innerHTML = '<span>'+opt.label+'</span>';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.setAttribute('aria-label','Hapus '+opt.label);
        btn.innerHTML = '‚úï';
        btn.addEventListener('click', ()=>{
          setSelected(opt.value, false);
        });
        chip.appendChild(btn);
        chipsWrap.appendChild(chip);
      });
      if (placeholder) {
        placeholder.style.display = selected.length ? 'none':'inline';
      }
    }

    // Sync ke <select>
    function syncSelect(){
      if (!selectEl) return;
      
      for(const o of selectEl.options){ o.selected = false; }
      options.forEach((opt, i)=>{
        if(opt.selected) selectEl.options[i].selected = true;
      });
      const evt = new Event('change', {bubbles:true});
      selectEl.dispatchEvent(evt);
    }

    function setSelected(value, state){
      const opt = options.find(o=>o.value===value);
      if(!opt) return;
      opt.selected = !!state;
      const item = listWrap?.querySelector('[data-value="'+CSS.escape(value)+'"] input[type="checkbox"]');
      if(item) item.checked = opt.selected;
      const row = listWrap?.querySelector('[data-value="'+CSS.escape(value)+'"]');
      if(row) row.setAttribute('aria-selected', String(!!state));
      renderChips();
      syncSelect();
    }
    
    function toggleValue(value){
      const opt = options.find(o=>o.value===value);
      setSelected(value, !opt.selected);
    }

    function filterList(q){
      const term = (q||'').trim().toLowerCase();
      const filtered = term ? options.filter(o=>o.label.toLowerCase().includes(term)) : options;
      renderList(filtered);
    }

    function initMultiSelectEvents() {
      // Select all / clear
      if (btnSelectAll) {
        btnSelectAll.addEventListener('click', ()=>{
          options.forEach(o=>o.selected = true);
          renderList();
          renderChips();
          syncSelect();
        });
      }
      
      if (btnClear) {
        btnClear.addEventListener('click', ()=>{
          options.forEach(o=>o.selected = false);
          renderList();
          renderChips();
          syncSelect();
        });
      }

      // Open/close handlers
      if (msControl) {
        msControl.addEventListener('click', (e)=>{
          if(dropdown.classList.contains('open')) return;
          openDropdown();
        });
      }
      
      if (inputInline) {
        inputInline.addEventListener('focus', ()=>{ if(!dropdown.classList.contains('open')) openDropdown(); });
        inputInline.addEventListener('input', (e)=> filterList(e.target.value));
      }

      if (searchDup) {
        searchDup.addEventListener('input', (e)=> filterList(e.target.value));
      }

      // Backspace hapus chip terakhir jika input kosong
      if (inputInline) {
        inputInline.addEventListener('keydown', (e)=>{
          if(e.key === 'Backspace' && !inputInline.value && options.some(o=>o.selected)){
            const last = [...options].reverse().find(o=>o.selected);
            if(last) setSelected(last.value, false);
          }
          if(e.key === 'ArrowDown'){ e.preventDefault(); openDropdown(); }
        });
      }

      document.addEventListener('click', (e)=>{
        if(!msRoot?.contains(e.target)) closeDropdown();
      });
      
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeDropdown();
      });
    }

    // Estimasi perubahannya mengikuti select#paket
    function initializeEstimation() {
      const estimasiDiv = document.getElementById('estimasi');
      const selectEl = document.getElementById('paket');
      
      if (!estimasiDiv || !selectEl) return;

      function hitungEstimasi(){
        const selectedValues = Array.from(selectEl.selectedOptions).map(opt=>{
          const [id, nama, harga] = opt.value.split('|');
          return { id, nama, harga: parseInt(harga) };
        });
        
        let total = 0;
        let list = '';
        selectedValues.forEach(({nama, harga})=>{
          total += harga || 0;
          list += '- '+nama+' (Rp '+ harga.toLocaleString('id-ID') +')\n';
        });
        
        if(selectedValues.length){
          estimasiDiv.innerHTML =
            '<p><strong>Estimasi Total:</strong> Rp '+ total.toLocaleString('id-ID') +'</p>'+
            '<pre style="margin:0;white-space:pre-wrap">'+list+'</pre>';
        } else {
          estimasiDiv.textContent = '';
        }
      }

      selectEl.addEventListener('change', hitungEstimasi);
    }

    // Initialize location button
    function initializeLocationButton() {
      const btnLokasi = document.getElementById('btnLokasi');
      const lokasiInfo = document.getElementById('lokasiInfo');
      
      if (!btnLokasi || !lokasiInfo) return;

      btnLokasi.addEventListener('click', async ()=>{
        if(!navigator.geolocation){
          alert('Browser Anda tidak mendukung geolocation.');
          return;
        }
        btnLokasi.disabled = true;
        const prev = btnLokasi.textContent;
        btnLokasi.textContent = 'üìç Mendapatkan lokasi...';
        
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          
          // Tampilkan marker di peta
          if (marker && map) {
            map.removeLayer(marker);
          }
          if (map) {
            marker = L.marker([userLat, userLng]).addTo(map);
            map.setView([userLat, userLng], 15);
          }

          lokasiInfo.hidden = false;
          lokasiInfo.innerHTML = '<strong>üìç Koordinat Anda:</strong><br>' +
            'Lat: '+userLat.toFixed(6)+', Lng: '+userLng.toFixed(6) +
            '<br><a target="_blank" href="https://www.google.com/maps?q='+userLat+','+userLng+'">Lihat di Google Maps</a>';
          btnLokasi.textContent = '‚úÖ Lokasi Berhasil Didapatkan';
          btnLokasi.disabled = false;

          // Ambil alamat dari koordinat
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLng}&addressdetails=1`
            );
            const data = await response.json();

            if (data && data.address) {
              const addr = data.address;
              document.getElementById("alamat").value = data.display_name || "Tidak diketahui";
              document.getElementById("kelurahan").value = addr.suburb || addr.village || addr.hamlet || "";
              document.getElementById("kecamatan").value = addr.city_district || addr.county || addr.state_district || "";
              document.getElementById("kota").value = addr.city || addr.town || addr.municipality || addr.state || "";
            }
          } catch (err) {
            console.error("Gagal mengambil alamat:", err);
          }
        },()=>{
          alert('Gagal mendapatkan lokasi. Aktifkan GPS dan izinkan akses lokasi.');
          btnLokasi.textContent = prev;
          btnLokasi.disabled = false;
        },{enableHighAccuracy:true, timeout:10000});
      });
    }

    // Initialize form submission
    function initializeFormSubmission() {
      const form = document.getElementById('orderForm');
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const submitSpinner = document.getElementById('submitSpinner');
      
      if (!form || !submitBtn || !submitText || !submitSpinner) return;

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();

        const selectEl = document.getElementById('paket');
        if (!selectEl) return;

        // Validasi minimal: wajib pilih paket
        if(selectEl.selectedOptions.length === 0){
          alert('Silakan pilih minimal satu paket.');
          openDropdown();
          return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitText.textContent = 'Mengirim...';
        submitSpinner.style.display = 'inline-block';

        try {
          const nama = document.getElementById('nama').value.trim();
          const telepon = document.getElementById('telepon').value.trim();
          const alamat = document.getElementById('alamat').value.trim();
          const kelurahan = document.getElementById('kelurahan').value.trim();
          const kecamatan = document.getElementById('kecamatan').value.trim();
          const kota = document.getElementById('kota').value.trim();
          const tanggal = document.getElementById('tanggal').value;
          const pukul = document.getElementById('pukul').value;
          
          const selectedPackages = Array.from(selectEl.selectedOptions).map(opt=>{
            const [id, nama, harga] = opt.value.split('|');
            return { id: parseInt(id), nama, harga: parseInt(harga) };
          });

          const lokasiLink = (userLat && userLng)
            ? ('https://www.google.com/maps?q='+userLat+','+userLng)
            : 'Belum membagikan lokasi';

          // 1. Simpan ke database
          const { data: order, error: orderError } = await supabase
            .from('orders')
            .insert([{
              name: nama,
              phone: telepon,
              address: alamat,
              kelurahan: kelurahan,
              kecamatan: kecamatan,
              kota: kota,
              map_link: lokasiLink,
              latitude: userLat,
              longitude: userLng,
              visit_date: tanggal,
              visit_time: pukul
            }])
            .select()
            .single();

          if (orderError) throw orderError;

      // 2. Simpan order_packages
if (order && selectedPackages.length > 0) {
  const orderPackages = selectedPackages.map(pkg => ({
    order_id: order.id,
    package_id: pkg.id,
    unit_price: pkg.harga // TAMBAHKAN INI
  }));

  const { error: pivotError } = await supabase
    .from('order_packages')
    .insert(orderPackages);

  if (pivotError) throw pivotError;
}

          // 3. Kirim ke WhatsApp
          const total = selectedPackages.reduce((sum, pkg) => sum + pkg.harga, 0);
          const packageList = selectedPackages.map(pkg => '- ' + pkg.nama + ' (Rp ' + pkg.harga.toLocaleString('id-ID') + ')').join('\n');
          
          const pesan = `
Mohon di lengkapi data pemesanannya sebagai berikut pak/bu

‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
#Pemesan#
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
Nama: ${nama}
No.Tlp: ${telepon}
Alamat: ${alamat}
Kelurahan: ${kelurahan}
Kecamatan: ${kecamatan}
Kota: ${kota}
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
#Waktu Kunjungan#
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
Tgl: ${tanggal}
Pukul: ${pukul}
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
#Rincian Layanan#
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
Item yang dikerjakan & Estimasi Biayanya:
${packageList}
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
Total: Rp ${total.toLocaleString('id-ID')}
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
Lokasi: ${lokasiLink}`.trim();

          const encoded = encodeURIComponent(pesan);
          const target = '6287887407806';
          window.open('https://wa.me/'+target+'?text='+encoded, '_blank');

          // 4. Show success message
          showToast('Order berhasil dikirim ke WhatsApp dan database!');
          
          // 5. Reset form
          form.reset();
          options.forEach(opt => opt.selected = false);
          renderChips();
          renderList();
          userLat = null;
          userLng = null;
          const lokasiInfo = document.getElementById('lokasiInfo');
          if (lokasiInfo) lokasiInfo.hidden = true;
          if (marker && map) map.removeLayer(marker);

        } catch (error) {
          console.error('Error submitting order:', error);
          showToast('Terjadi kesalahan saat menyimpan order', 'error');
        } finally {
          // Reset button state
          submitBtn.disabled = false;
          submitText.textContent = 'Kirim ke WhatsApp';
          submitSpinner.style.display = 'none';
        }
      });
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      initMap();
      loadPackages();
      initializeLocationButton();
      initializeFormSubmission();
      initializeEstimation();
    });

  </script>
</body>
</html>